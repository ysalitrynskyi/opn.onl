version: '3.8'

# ===========================================
# PORTAINER DEPLOYMENT - ARM64 (aarch64)
# ===========================================
# For ARM-based servers (Raspberry Pi, AWS Graviton, etc.)
# 
# Images are automatically built by GitHub Actions.
# Just set BACKEND_IMAGE and FRONTEND_IMAGE in your .env:
#   BACKEND_IMAGE=ghcr.io/ysalitrynskyi/opn-backend:latest
#   FRONTEND_IMAGE=ghcr.io/ysalitrynskyi/opn-frontend:latest

services:
  db:
    image: postgres:15-alpine
    container_name: opn_onl_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-opn_onl}
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opn-network

  redis:
    image: redis:7-alpine
    container_name: opn_onl_redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - opn-network

  backend:
    image: ${BACKEND_IMAGE:-ghcr.io/ysalitrynskyi/opn-backend:latest}
    platform: linux/arm64
    container_name: opn_onl_backend
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-opn_onl}
      JWT_SECRET: ${JWT_SECRET}
      HOST: 0.0.0.0
      PORT: 3000
      BASE_URL: ${BASE_URL:-https://opn.onl}
      FRONTEND_URL: ${FRONTEND_URL:-https://opn.onl}
      FORCE_HTTPS: ${FORCE_HTTPS:-true}
      RUST_LOG: ${RUST_LOG:-info,tower_http=debug}
      LOG_DIR: /app/logs
      REDIS_URL: redis://redis:6379
      REDIS_CACHE_TTL: ${REDIS_CACHE_TTL:-300}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-noreply@opn.onl}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-opn.onl}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@opn.onl}
      BACKUP_S3_ENDPOINT: ${BACKUP_S3_ENDPOINT:-}
      BACKUP_S3_BUCKET: ${BACKUP_S3_BUCKET:-}
      BACKUP_S3_ACCESS_KEY: ${BACKUP_S3_ACCESS_KEY:-}
      BACKUP_S3_SECRET_KEY: ${BACKUP_S3_SECRET_KEY:-}
      BACKUP_S3_REGION: ${BACKUP_S3_REGION:-auto}
      CLICK_BUFFER_SIZE: ${CLICK_BUFFER_SIZE:-100}
      CLICK_FLUSH_INTERVAL: ${CLICK_FLUSH_INTERVAL:-10}
      MAXMIND_ACCOUNT_ID: ${MAXMIND_ACCOUNT_ID:-}
      MAXMIND_LICENSE_KEY: ${MAXMIND_LICENSE_KEY:-}
    volumes:
      - backend_logs:/app/logs
      - backend_geoip:/app/data
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - opn-network

  frontend:
    image: ${FRONTEND_IMAGE:-ghcr.io/ysalitrynskyi/opn-frontend:latest}
    platform: linux/arm64
    container_name: opn_onl_frontend
    restart: unless-stopped
    depends_on:
      - backend
    environment:
      # Google Analytics (optional) - set to your GA4 tracking ID
      GA_ID: ${GA_ID:-}
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - opn-network

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: opn_onl_cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - backend
      - frontend
    networks:
      - opn-network

  # Optional: Database admin UI
  # Expose via Cloudflare tunnel only when needed (e.g., db.opn.onl)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: opn_onl_pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@opn.onl}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: "False"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - db
    networks:
      - opn-network
    # Uncomment to expose locally (not recommended for production)
    # ports:
    #   - "5050:80"

volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
  backend_logs:
    driver: local
  backend_geoip:
    driver: local
  pgadmin_data:
    driver: local

networks:
  opn-network:
    driver: bridge

